#!/usr/bin/env bash
#
# Wrapper script to update system packages and dotfiles
# Executes: task system:update

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if task is available
if ! command -v task >/dev/null 2>&1; then
  echo -e "${RED}Error: 'task' command not found${NC}"
  echo "Please ensure go-task is installed and in your PATH"
  exit 1
fi

# Check if we're in the dotfiles directory
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
DOTFILES_BRANCH="${DOTFILES_BRANCH:-main}"

if [[ ! -d "$DOTFILES_DIR" ]]; then
  echo -e "${RED}Error: Dotfiles directory not found at $DOTFILES_DIR${NC}"
  exit 1
fi

# Run the update task from the dotfiles directory
echo -e "${BLUE}Updating system packages and dotfiles...${NC}"
echo ""

cd "$DOTFILES_DIR"
# Stash any local changes
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
  echo -e "${BLUE}‚ö†Ô∏è  Local changes detected - auto-stashing for safety${NC}"
  git stash push -m "Auto-stash before bootstrap pull $(date +%Y-%m-%d-%H%M%S)"
  echo -e "${BLUE}‚ÑπÔ∏è  Your changes are saved in: git stash list${NC}"
fi

# Pull latest changes
echo -e "${BLUE}üì• Updating from remote...${NC}"
git pull origin $DOTFILES_BRANCH

# Inform about stash but don't auto-pop (safer)
if git stash list | grep -q "Auto-stash before bootstrap"; then
  echo ""
  echo -e "${BLUE}‚ÑπÔ∏è  Note: Stashed changes can be restored with: git stash pop${NC}"
  echo -e "${BLUE}‚ÑπÔ∏è  Or review with: git stash list${NC}"
fi

task system:update

echo ""
echo -e "${GREEN}‚úì Update complete!${NC}"

