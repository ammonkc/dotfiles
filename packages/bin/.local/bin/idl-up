#!/bin/bash
#
# Start IDL Docker containers
# Usage: idl-up [worktree] [domain]
#        worktree - defaults to 'main'
#        domain   - defaults to 'allegro.test'
#

BASE_DIR="$HOME/Developer/code/indirect"
WORKTREE="${1:-main}"
ALLEGRO_DOMAIN="${2:-allegro.test}"

# Get list of available worktrees (directories in BASE_DIR)
# Uses fd if available, otherwise falls back to find
get_worktrees() {
    if command -v fd &>/dev/null; then
        fd --type d --max-depth 1 --base-directory "$BASE_DIR" . 2>/dev/null | sort
    else
        /usr/bin/find "$BASE_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; 2>/dev/null | sort
    fi
}

PROJECT_DIR="$BASE_DIR/$WORKTREE"

# Validate worktree exists
if [[ ! -d "$PROJECT_DIR" ]]; then
    echo "❌ Worktree '$WORKTREE' not found"
    echo "Available: $(get_worktrees | tr '\n' ' ')"
    exit 1
fi

cd "$PROJECT_DIR" || { echo "❌ Cannot find $PROJECT_DIR"; exit 1; }

ALLEGRO_DOMAIN="$ALLEGRO_DOMAIN" docker compose -f docker-compose.yaml \
    --profile sftp \
    up --force-recreate --build --detach --remove-orphans

echo "✅ IDL containers started ($WORKTREE) @ $ALLEGRO_DOMAIN"

