#!/bin/bash
# Automated AWS SSO login via Playwright + 1Password
# Requires: node, playwright, op CLI, granted
#
# Usage: genai-auto-login [options]
#
# Options:
#   --debug     Show browser window (non-headless) for troubleshooting
#   --profile   AWS profile name (default: genai)
#   --help      Show this help message
#
# Environment variables:
#   OP_WORK_ACCOUNT   1Password work account (e.g., "ncinoinc.1password.com")
#   OP_SSO_ITEM       1Password item name with SSO credentials (e.g., "nCino - SSO")
#
# This script automates the AWS SSO login flow by:
# 1. Reading AWS SSO start URL from ~/.aws/config
# 2. Fetching credentials from 1Password
# 3. Starting the assume command (Granted)
# 4. Using Playwright to automate the Azure AD login
# 5. Entering TOTP from 1Password
# 6. Clicking Allow to authorize

set -e

# Defaults
HEADLESS=true
AWS_PROFILE="${AWS_PROFILE:-genai}"
DEBUG=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --debug)
            HEADLESS=false
            DEBUG=true
            shift
            ;;
        --profile)
            AWS_PROFILE="$2"
            shift 2
            ;;
        --help|-h)
            sed -n '2,/^$/p' "$0" | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# 1Password configuration
OP_ACCOUNT="${OP_WORK_ACCOUNT:-}"
OP_ITEM="${OP_SSO_ITEM:-}"

# Check dependencies
check_deps() {
    local missing=()
    command -v op >/dev/null 2>&1 || missing+=("op (1Password CLI)")
    command -v node >/dev/null 2>&1 || missing+=("node")
    command -v granted >/dev/null 2>&1 || missing+=("granted")
    command -v jq >/dev/null 2>&1 || missing+=("jq")

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "‚ùå Missing dependencies:"
        for dep in "${missing[@]}"; do
            echo "   - $dep"
        done
        echo ""
        echo "Install with: brew install 1password-cli node jq common-fate/granted/granted"
        exit 1
    fi
}

# Get AWS SSO start URL from config
get_sso_start_url() {
    local config_file="$HOME/.aws/config"

    if [[ ! -f "$config_file" ]]; then
        echo "‚ùå AWS config not found at $config_file" >&2
        exit 1
    fi

    # First, find the sso_session name for this profile
    local sso_session
    sso_session=$(awk -v profile="$AWS_PROFILE" '
        /^\[profile / { in_profile = ($0 ~ "\\[profile " profile "\\]") }
        in_profile && /sso_session/ { gsub(/.*= */, ""); print; exit }
    ' "$config_file")

    if [[ -z "$sso_session" ]]; then
        echo "‚ùå Profile '$AWS_PROFILE' not found or has no sso_session in $config_file" >&2
        exit 1
    fi

    # Now find the sso_start_url for that session
    local start_url
    start_url=$(awk -v session="$sso_session" '
        /^\[sso-session / { in_session = ($0 ~ "\\[sso-session " session "\\]") }
        in_session && /sso_start_url/ { gsub(/.*= */, ""); print; exit }
    ' "$config_file")

    if [[ -z "$start_url" ]]; then
        echo "‚ùå Could not find sso_start_url for session '$sso_session'" >&2
        exit 1
    fi

    echo "$start_url"
}

# Validate 1Password configuration
validate_op_config() {
    if [[ -z "$OP_ACCOUNT" ]]; then
        echo "‚ùå OP_WORK_ACCOUNT not set"
        echo "   Add to ~/.env.local: export OP_WORK_ACCOUNT=\"your-company.1password.com\""
        exit 1
    fi

    if [[ -z "$OP_ITEM" ]]; then
        echo "‚ùå OP_SSO_ITEM not set"
        echo "   Add to ~/.env.local: export OP_SSO_ITEM=\"Your SSO Item Name\""
        exit 1
    fi

    # Check if signed in to 1Password
    if ! op account get --account "$OP_ACCOUNT" >/dev/null 2>&1; then
        echo "‚ùå Not signed in to 1Password account: $OP_ACCOUNT"
        echo "   Run: op signin --account $OP_ACCOUNT"
        exit 1
    fi
}

# Main execution
main() {
    check_deps

    echo "üîß AWS Profile: $AWS_PROFILE"
    [[ "$DEBUG" == "true" ]] && echo "üêõ Debug mode: browser will be visible"

    # Get SSO start URL
    echo "üìç Reading AWS SSO configuration..."
    SSO_START_URL=$(get_sso_start_url)
    echo "   Start URL: $SSO_START_URL"

    # Validate 1Password setup
    validate_op_config

    echo "üîê Fetching credentials from 1Password..."
    USERNAME=$(op read "op://Employee/$OP_ITEM/username" --account "$OP_ACCOUNT" 2>/dev/null) || {
        echo "‚ùå Failed to get username from 1Password item: $OP_ITEM"
        echo "   Ensure the item exists in the 'Employee' vault with a 'username' field"
        exit 1
    }
    PASSWORD=$(op read "op://Employee/$OP_ITEM/password" --account "$OP_ACCOUNT" 2>/dev/null) || {
        echo "‚ùå Failed to get password from 1Password item: $OP_ITEM"
        exit 1
    }
    TOTP=$(op item get "$OP_ITEM" --otp --account "$OP_ACCOUNT" 2>/dev/null) || {
        echo "‚ùå Failed to get TOTP from 1Password item: $OP_ITEM"
        echo "   Ensure TOTP is configured for this item"
        exit 1
    }

    echo "‚úì Credentials retrieved"
    echo "üöÄ Starting AWS SSO login..."

    # Create temp file for capturing output
    TEMP_LOG=$(mktemp)
    trap "rm -f $TEMP_LOG" EXIT

    # Start assume in background, capture output
    ASSUME_BIN=$(command -v assume || command -v granted)
    "$ASSUME_BIN" "$AWS_PROFILE" 2>&1 | tee "$TEMP_LOG" &
    ASSUME_PID=$!

    # Wait for the device URL to appear in output
    echo "‚è≥ Waiting for device authorization URL..."
    DEVICE_URL=""
    for i in {1..15}; do
        sleep 1
        # Generic pattern: match any *.awsapps.com/start/#/device URL
        DEVICE_URL=$(grep -oE 'https://[^[:space:]]+\.awsapps\.com/start/#/device[^[:space:]]*' "$TEMP_LOG" 2>/dev/null | head -1 || true)
        if [[ -n "$DEVICE_URL" ]]; then
            break
        fi
    done

    if [[ -z "$DEVICE_URL" ]]; then
        echo "‚ùå Could not capture device authorization URL"
        echo "   Check if you're already authenticated or if assume is working correctly"
        kill $ASSUME_PID 2>/dev/null || true
        exit 1
    fi

    echo "üåê Automating browser login at Azure AD..."
    [[ "$DEBUG" == "true" ]] && echo "   Device URL: $DEVICE_URL"

    # Export variables for Node.js subprocess
    export DEVICE_URL
    export SSO_USERNAME="$USERNAME"
    export SSO_PASSWORD="$PASSWORD"
    export SSO_TOTP="$TOTP"
    export HEADLESS_VALUE="$HEADLESS"

    # Run Playwright automation
    node << 'PLAYWRIGHT_SCRIPT'
const { chromium } = require('playwright');

const DEVICE_URL = process.env.DEVICE_URL;
const USERNAME = process.env.SSO_USERNAME;
const PASSWORD = process.env.SSO_PASSWORD;
const TOTP = process.env.SSO_TOTP;
const HEADLESS = process.env.HEADLESS_VALUE === 'true';

(async () => {
    const browser = await chromium.launch({
        headless: HEADLESS,
        slowMo: HEADLESS ? 0 : 100  // Slow down in debug mode
    });
    const context = await browser.newContext();
    const page = await context.newPage();

    try {
        console.log('üìç Navigating to device authorization...');
        await page.goto(DEVICE_URL);

        // Wait for Azure AD login page
        console.log('üìç Waiting for Azure AD...');
        await page.waitForURL(/login\.microsoftonline\.com/, { timeout: 15000 });

        // Fill email/username
        console.log('üìç Entering username...');
        await page.waitForSelector('input[type="email"], input[name="loginfmt"]', { timeout: 10000 });
        await page.fill('input[type="email"], input[name="loginfmt"]', USERNAME);
        await page.click('input[type="submit"], button[type="submit"]');

        // Wait for password page
        console.log('üìç Entering password...');
        await page.waitForSelector('input[type="password"], input[name="passwd"]', { timeout: 10000 });
        await page.waitForTimeout(500); // Brief pause for page transition
        await page.fill('input[type="password"], input[name="passwd"]', PASSWORD);
        await page.click('input[type="submit"], button[type="submit"]');

        // Wait for MFA/TOTP page
        console.log('üìç Entering TOTP code...');
        await page.waitForSelector('input[name="otc"], input[id="idTxtBx_SAOTCC_OTC"]', { timeout: 15000 });
        await page.waitForTimeout(500);
        await page.fill('input[name="otc"], input[id="idTxtBx_SAOTCC_OTC"]', TOTP);
        await page.click('input[type="submit"], button[type="submit"]');

        // Handle "Stay signed in?" prompt if it appears
        try {
            await page.waitForSelector('input[id="idBtn_Back"], button:has-text("No")', { timeout: 3000 });
            await page.click('input[id="idBtn_Back"], button:has-text("No")');
        } catch (e) {
            // Prompt didn't appear, continue
        }

        // Wait for AWS authorization page
        console.log('üìç Waiting for AWS authorization page...');
        await page.waitForURL(/awsapps\.com/, { timeout: 20000 });

        // Click Allow button
        console.log('üìç Clicking Allow...');
        await page.waitForSelector('button:has-text("Allow"), input[value="Allow"], #cli_login_button', { timeout: 10000 });
        await page.click('button:has-text("Allow"), input[value="Allow"], #cli_login_button');

        // Wait for success confirmation
        await page.waitForTimeout(2000);
        console.log('‚úÖ Browser automation complete!');

    } catch (error) {
        console.error('‚ùå Browser automation failed:', error.message);
        // Take screenshot for debugging
        await page.screenshot({ path: '/tmp/genai-login-error.png' });
        console.error('   Screenshot saved to /tmp/genai-login-error.png');
        process.exit(1);
    } finally {
        await browser.close();
    }
})();
PLAYWRIGHT_SCRIPT

    # Wait for assume to complete
    echo "‚è≥ Waiting for credentials..."
    wait $ASSUME_PID 2>/dev/null || true

    echo ""
    echo "‚úÖ AWS $AWS_PROFILE credentials ready!"
    echo "   Run 'aws sts get-caller-identity --profile $AWS_PROFILE' to verify"
}

main "$@"
