#!/usr/bin/env bash
# Preview macOS defaults that will be applied
# Displays all the macOS defaults commands that will be run by macos.sh
set -e

# Color helper functions
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() { echo -e "${BLUE}âš™ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ“ $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
tip() { echo -e "${YELLOW}ðŸ’¡ $1${NC}"; }

# Determine the dotfiles directory
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
MACOS_SCRIPT="$DOTFILES_DIR/scripts/macos.sh"
MACOS_PREVIEW_SCRIPT="$DOTFILES_DIR/scripts/macos-preview.sh"

# Check if we're on macOS
if [[ "$(uname)" != "Darwin" ]]; then
  error "This script is only supported on macOS"
  exit 1
fi

# Check if dotfiles directory exists
if [[ ! -d "$DOTFILES_DIR" ]]; then
  error "Dotfiles directory not found at $DOTFILES_DIR"
  tip "Please ensure your dotfiles are cloned to $DOTFILES_DIR"
  exit 1
fi

# Check if macos.sh exists
if [[ ! -f "$MACOS_SCRIPT" ]]; then
  error "macOS defaults script not found at $MACOS_SCRIPT"
  exit 1
fi

# Check if macos-preview.sh exists
if [[ ! -f "$MACOS_PREVIEW_SCRIPT" ]]; then
  error "macOS preview script not found at $MACOS_PREVIEW_SCRIPT"
  exit 1
fi

# Ensure glow is installed
if ! command -v glow >/dev/null 2>&1; then
  error "glow is not installed"
  tip "Install it with: brew install glow"
  exit 1
fi

# Create temp file for preview
PREVIEW_FILE=$(mktemp /tmp/macos-defaults-preview.XXXXXX.md)

# Cleanup function to remove temp file
cleanup() {
  rm -f "$PREVIEW_FILE"
}

# Register cleanup on exit
trap cleanup EXIT INT TERM

# Generate the preview
info "Generating macOS defaults preview..."
if ! bash "$MACOS_PREVIEW_SCRIPT" "$MACOS_SCRIPT" "$PREVIEW_FILE"; then
  error "Failed to generate preview"
  exit 1
fi

# Display the preview with glow
info "Displaying preview with glow..."
glow "$PREVIEW_FILE"

success "Preview completed"

