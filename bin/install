#!/bin/bash
########################################################################################################################
#### â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#### â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
#### â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#### â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘
#### â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#### â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
########################################################################################################################

set -e

# Color helper functions
info() { echo -e "\033[0;34mâš™ï¸  $1\033[0m"; }
success() { echo -e "\033[0;32mâœ“ $1\033[0m"; }
error() { echo -e "\033[0;31mâŒ $1\033[0m"; }
warning() { echo -e "\033[1;33mâš ï¸  $1\033[0m"; }

# Set XDG base paths and export them so Homebrew and other tools can use them
export XDG_CACHE_HOME=${XDG_CACHE_HOME:-$HOME/.cache}
export XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}
export XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}
export XDG_STATE_HOME=${XDG_STATE_HOME:-$HOME/.local/state}
export XDG_BIN_DIR=${XDG_BIN_DIR:-$HOME/.local/bin}

# Source exports to set tool-specific paths (GNUPGHOME, GEM_HOME, etc.)
[[ -e $HOME/.dotfiles/packages/zsh/.config/zsh/exports.zsh ]] && source $HOME/.dotfiles/packages/zsh/.config/zsh/exports.zsh

# Ensure gnupg directory exists with strict permissions (700)
mkdir -p "$GNUPGHOME"
chmod 700 "$GNUPGHOME"

# Install go-task if not present
if ! command -v task > /dev/null; then
  info "Installing go-task..."
  mkdir -p "$XDG_BIN_DIR"
  sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b "$XDG_BIN_DIR" || {
    error "Failed to install go-task"
    exit 1
  }
  success "go-task installed successfully"
else
  success "go-task already installed ($(task --version))"
fi

# Add go-task to PATH for this session
export PATH="$XDG_BIN_DIR:$PATH"

# Verify go-task is now available
if ! command -v task > /dev/null; then
  error "go-task installed but not found in PATH"
  error "Please add $XDG_BIN_DIR to your PATH and try again"
  exit 1
fi

# Add Homebrew to PATH if it exists but isn't in current PATH
if [ -f /opt/homebrew/bin/brew ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -f /usr/local/bin/brew ]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi

# Run the main installation
info "Running installation tasks..."
if task install; then
  echo ""
  success "Setup complete! ðŸŽ‰"
  echo ""
  info "$(tput bold)Next steps:$(tput sgr0)"
  echo ""
  echo "  1. Restart your terminal or run: $(tput bold)exec \$SHELL$(tput sgr0)"
  echo ""

  # macOS-specific next steps
  if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "  2. $(tput bold)[Optional]$(tput sgr0) Apply macOS system preferences:"
    echo "     â€¢ Configures Finder, Dock, keyboard, and more"
    echo "     â€¢ Preview changes first: $(tput bold)dotfiles mac:preview:defaults$(tput sgr0)"
    echo "     â€¢ Apply settings: $(tput bold)dotfiles mac:set:defaults$(tput sgr0)"
    echo ""
    echo "  3. $(tput bold)[Optional]$(tput sgr0) Enable 1Password SSH agent:"
    echo "     â€¢ Open 1Password â†’ Settings â†’ Developer"
    echo "     â€¢ Enable 'Use the SSH agent'"
    echo "     â€¢ Run: $(tput bold)dotfiles mac:op:setup$(tput sgr0)"
    echo ""
    echo "  4. Customize local configs if needed:"
  else
    echo "  2. Customize local configs if needed:"
  fi

  echo "     â€¢ ~/.config/git/config.local"
  echo "     â€¢ ~/.config/zsh/.zshrc.local"
  echo "     â€¢ ~/.config/mise/.mise.local.toml"
  echo ""

  if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "  5. Run: $(tput bold)dotfiles --list$(tput sgr0) to see all available commands"
  else
    echo "  3. Run: $(tput bold)dotfiles --list$(tput sgr0) to see all available commands"
  fi
  echo ""
  info "ðŸ’¡ Tip: Use $(tput bold)dotfiles <command>$(tput sgr0) from anywhere to run dotfiles tasks"
  echo ""
else
  error "Installation failed"
  exit 1
fi
