# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

includes:
  brew:
    taskfile: ./brew.yml
    internal: true

  linux:
    taskfile: ./linux.yml
    internal: true

  mise:
    taskfile: ./mise.yml
    internal: true

  dotfiles:
    aliases: [dot]
    taskfile: ./dotfiles.yml

  secrets:
    taskfile: ./secrets.yml
    internal: true

  develop:
    taskfile: ./develop.yml
    internal: true

vars:
  HOME: '{{env "HOME"}}'
  OP_ACCOUNT: '{{.OP_ACCOUNT | default "my.1password.com"}}'

tasks:
  install:
    desc: Install all system dependencies
    summary: |
      Install all system dependencies

      This task will install all required system tools and dependencies
      for both macOS and Linux platforms.

      After this completes:
        1. Sign into 1Password: op signin
        2. Run: task system:post-install
    cmds:
      - task: install:requirements

  post-install:
    desc: Post-installation setup (requires 1Password)
    summary: |
      Run this after signing into 1Password

      This task configures:
        - Git credentials and signing keys from 1Password
        - SSH config with GitHub username
        - Work-specific git configs
        - Development directory structure

      Prerequisites:
        - 1Password CLI installed (via system:install)
        - Signed into 1Password (op signin)
    silent: true
    preconditions:
      - sh: op account get --account {{.OP_ACCOUNT}} >/dev/null 2>&1
        msg: |
          ❌ Not signed into 1Password

          Please sign in first:
            op signin

          Then run this task again.
    cmds:
      - task: secrets:install
      - task develop:setup
      - echo ""
      - echo "✅ Post-installation complete!"
      - echo ""
      - echo "Your development environment is ready."

  install:requirements:
    internal: true
    cmds:
      - task: install:stow
      - task: dot:install
      - task: install:platform_tools

  install:stow:
    internal: true
    desc: Install stow (required before dotfiles can be stowed)
    cmds:
      - task: brew:install
      - task: linux:install:stow

  update:
    desc: Update all system dependencies
    summary: |
      Updates system packages and mise-managed tools

      On macOS: Updates Homebrew packages
      On Linux: Updates system packages via package manager

      Run this periodically to keep your system up to date
    cmds:
      - task: brew:upgrade
      - task: linux:update
      - task: mise:update

  install:platform_tools:
    internal: true
    cmds:
      - task: brew:install:tools
      - task: linux:install
