# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  MACOS_SCRIPT: '{{.ROOT_DIR}}/scripts/macos.sh'

tasks:
  set:defaults:
    desc: Apply all macOS system preferences
    summary: |
      Applies custom macOS defaults and preferences

      This will:
      - Back up current defaults to ~/Desktop
      - Apply settings for Dock, Finder, Safari, Mail, and more
      - Restart affected applications
      - Some changes require logout/restart to take full effect

      Run this on a fresh Mac setup or when you want to reapply settings.
    platforms: [darwin]
    preconditions:
      - sh: test -f "{{.MACOS_SCRIPT}}"
        msg: "macOS defaults script not found at {{.MACOS_SCRIPT}}"
    cmds:
      - bash "{{.MACOS_SCRIPT}}"

  restart:dock:
    desc: Restart Dock to apply settings
    platforms: [darwin]
    cmds:
      - killall Dock

  restart:finder:
    desc: Restart Finder to apply settings
    platforms: [darwin]
    cmds:
      - killall Finder

  restart:all:
    desc: Restart Dock, Finder, and SystemUIServer
    platforms: [darwin]
    cmds:
      - echo "ðŸ”„ Restarting system UI components..."
      - killall Dock || true
      - killall Finder || true
      - killall SystemUIServer || true
      - echo "âœ“ UI components restarted"

  xcode:install:
    desc: Install Xcode command line tools
    platforms: [darwin]
    status:
      - xcode-select -p
    cmds:
      - xcode-select --install

  op:setup:
    desc: Setup 1Password SSH agent symlink
    summary: |
      Creates a symlink for 1Password SSH agent socket
      This enables cross-platform compatibility (Linux uses ~/.1password)
    platforms: [darwin]
    preconditions:
      - sh: test -S ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock
        msg: |
          1Password SSH agent is not enabled.

          Please:
          1. Open 1Password app
          2. Go to Settings â†’ Developer
          3. Enable "Use the SSH agent"
          4. Run this task again
    status:
      - test -L "$HOME/.1password/agent.sock"
    cmds:
      - echo "ðŸ”— Creating 1Password SSH agent symlink..."
      - mkdir -p ~/.1password
      - ln -s ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock ~/.1password/agent.sock
      - echo "âœ“ Symlink created successfully"

  sync:
    desc: Apply macOS defaults and restart UI components
    summary: |
      Convenience task that applies macOS defaults and restarts affected apps
      Equivalent to running: task mac:set:defaults && task mac:restart:all
    platforms: [darwin]
    cmds:
      - task: set:defaults
      - task: restart:all
