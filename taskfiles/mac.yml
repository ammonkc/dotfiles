# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

includes:
  clean:
    taskfile: ./clean.yml
    internal: true

vars:
  MACOS_SCRIPT: '{{.ROOT_DIR}}/scripts/macos.sh'

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  set:defaults:
    desc: Apply all macOS system preferences
    summary: |
      Applies custom macOS defaults and preferences

      This will:
      - Back up current defaults to ~/Desktop
      - Apply settings for Dock, Finder, Safari, Mail, and more
      - Restart affected applications
      - Some changes require logout/restart to take full effect

      Run this on a fresh Mac setup or when you want to reapply settings.
    platforms: [darwin]
    preconditions:
      - sh: test -f "{{.MACOS_SCRIPT}}"
        msg: "macOS defaults script not found at {{.MACOS_SCRIPT}}"
    cmds:
      - bash "{{.MACOS_SCRIPT}}"
      - task: github:force_ssh
      - task: clean:bootstrap_install

  preview:defaults:
    desc: Preview macOS defaults that will be applied
    summary: |
      Displays all the macOS defaults commands that will be run by macos.sh

      This extracts and formats all active defaults write commands for review.
      Useful for seeing what changes will be made before applying them.

      Requires: glow (install with: brew install glow)
    platforms: [darwin]
    vars:
      PREVIEW_FILE:
        sh: mktemp /tmp/macos-defaults-preview.XXXXXX.md
    preconditions:
      - sh: test -f "{{.MACOS_SCRIPT}}"
        msg: "macOS defaults script not found at {{.MACOS_SCRIPT}}"
      - sh: command -v glow
        msg: |
          glow is not installed. Install it with:
            brew install glow
    cmds:
      - bash "{{.ROOT_DIR}}/scripts/macos-preview.sh" "{{.MACOS_SCRIPT}}" "{{.PREVIEW_FILE}}"
      - defer: rm -f "{{.PREVIEW_FILE}}"
      - glow "{{.PREVIEW_FILE}}" | less -R

  github:force_ssh:
    desc: Force use of SSH for GitHub URLs
    summary: |
      Enables git URL rewriting to use SSH instead of HTTPS for GitHub.
      This uncomments the [url] section in ~/.gitconfig.local
    platforms: [darwin]
    vars:
      GITCONFIG_LOCAL: '{{.HOME}}/.gitconfig.local'
    preconditions:
      - sh: test -f "{{.GITCONFIG_LOCAL}}"
        msg: "gitconfig not found at {{.GITCONFIG_LOCAL}}"
    status:
      - grep -q '^\[url "git@github.com:"\]' "{{.GITCONFIG_LOCAL}}"
    cmds:
      - sed -i '' 's/^#\[url "git@github.com:"\]/[url "git@github.com:"]/' "{{.GITCONFIG_LOCAL}}"
      - sed -i '' 's/^#  insteadOf = https:\/\/github.com\//  insteadOf = https:\/\/github.com\//' "{{.GITCONFIG_LOCAL}}"
      - echo "âœ“ GitHub URLs will now use SSH"

  sync:
    desc: Apply macOS defaults and restart UI components
    summary: |
      Convenience task that applies macOS defaults and restarts affected apps
      Equivalent to running: task mac:set:defaults && task mac:restart:all
    platforms: [darwin]
    cmds:
      - task: set:defaults
      - task: restart:all

  xcode:install:
    desc: Install Xcode command line tools
    platforms: [darwin]
    status:
      - xcode-select -p
    cmds:
      - xcode-select --install

  op:setup:
    desc: Setup 1Password SSH agent symlink
    summary: |
      Creates a symlink for 1Password SSH agent socket
      This enables cross-platform compatibility (Linux uses ~/.1password)
    platforms: [darwin]
    preconditions:
      - sh: test -S ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock
        msg: |
          1Password SSH agent is not enabled.

          Please:
          1. Open 1Password app
          2. Go to Settings â†’ Developer
          3. Enable "Use the SSH agent"
          4. Run this task again
    status:
      - test -L "$HOME/.1password/agent.sock"
    cmds:
      - echo "ðŸ”— Creating 1Password SSH agent symlink..."
      - mkdir -p ~/.1password
      - ln -s ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock ~/.1password/agent.sock
      - echo "âœ“ Symlink created successfully"

  # ============================================================================
  # Utility Tasks
  # ============================================================================

  restart:dock:
    desc: Restart Dock to apply settings
    platforms: [darwin]
    cmds:
      - killall Dock

  restart:finder:
    desc: Restart Finder to apply settings
    platforms: [darwin]
    cmds:
      - killall Finder

  restart:all:
    desc: Restart Dock, Finder, and SystemUIServer
    platforms: [darwin]
    cmds:
      - echo "ðŸ”„ Restarting system UI components..."
      - killall Dock || true
      - killall Finder || true
      - killall SystemUIServer || true
      - echo "âœ“ UI components restarted"
