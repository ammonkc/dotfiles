# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  LAZY_LOCK: '${XDG_CONFIG_HOME:-$HOME/.config}/nvim/lazy-lock.json'
  LAZY_LOCK_REPO: 'packages/nvim/.config/nvim/lazy-lock.json'

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  restore:
    desc: Restore Neovim plugins to the state in lazy-lock.json
    summary: |
      Restores Neovim plugins to the state specified in lazy-lock.json
      Useful for bootstrapping a fresh machine or after cloning dotfiles

      Skips if plugins are already at the correct versions (checks lazy-lock.json hash)
    vars:
      NVIM_DATA: '${XDG_DATA_HOME:-$HOME/.local/share}/nvim'
      LAZY_LOCK_HASH:
        sh: test -f "{{.LAZY_LOCK}}" && shasum -a 256 "{{.LAZY_LOCK}}" | cut -d' ' -f1 || echo ""
      LAST_RESTORE_HASH:
        sh: test -f "{{.NVIM_DATA}}/.lazy-restore-hash" && cat "{{.NVIM_DATA}}/.lazy-restore-hash" || echo ""
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed. Run 'brew install neovim' first"
      - sh: test -f "{{.LAZY_LOCK}}"
        msg: "lazy-lock.json not found at {{.LAZY_LOCK}}"
    status:
      # Skip if lazy-lock.json hasn't changed since last restore
      - test -n "{{.LAZY_LOCK_HASH}}" && test "{{.LAZY_LOCK_HASH}}" = "{{.LAST_RESTORE_HASH}}"
    cmds:
      - echo "ðŸ“¦ Installing Neovim plugins (this may take a few minutes)..."
      # Ensure lazy.nvim is installed first
      - |
        LAZY_PATH="${XDG_DATA_HOME:-$HOME/.local/share}/nvim/lazy/lazy.nvim"
        if [[ ! -d "$LAZY_PATH" ]]; then
          echo "  â†’ Bootstrapping lazy.nvim..."
          git clone --filter=blob:none https://github.com/folke/lazy.nvim.git --branch=stable "$LAZY_PATH"
        fi
      # Now restore plugins (show output for progress)
      - |
        nvim --headless \
          +'Lazy! restore' \
          +'Lazy! clean' \
          +'TSUpdateSync' \
          +'autocmd User MasonUpdateAllCompleted qall!' \
          +'MasonUpdateAll' || true
      - mkdir -p "{{.NVIM_DATA}}"
      - echo "{{.LAZY_LOCK_HASH}}" > "{{.NVIM_DATA}}/.lazy-restore-hash"
      - echo "âœ“ Neovim plugins installed"

  update:
    desc: Update Neovim plugins, CLI utils, and TreeSitter
    summary: |
      Updates Neovim plugins, CLI utils, and TreeSitter plugins
      Automatically commits changes to lazy-lock.json if there are any
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed"
    cmds:
      - echo "ðŸ“¦ Updating Neovim plugins..."
      - |
        nvim --headless \
          +'Lazy! sync' \
          +'Lazy! clean' \
          +'TSUpdateSync' \
          +'autocmd User MasonUpdateAllCompleted qall!' \
          +'MasonUpdateAll' || true
      - task: commit

  check:
    desc: Verify Neovim setup and configuration
    summary: |
      Runs health checks to verify Neovim is properly configured
      Useful for debugging issues after fresh install
    cmds:
      - task: health

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  health:
    desc: Run Neovim health checks
    internal: true
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed"
    cmds:
      - nvim --headless +'checkhealth' +qa 2>/dev/null || true

  commit:
    desc: Commit lazy-lock.json if changed
    internal: true
    preconditions:
      - sh: test -f ./scripts/commit_changed_file.sh
        msg: "commit script not found at ./scripts/commit_changed_file.sh"
    cmds:
      - |
        ./scripts/commit_changed_file.sh \
          '{{.LAZY_LOCK_REPO}}' \
          "chore(nvim): update plugins $(date '+%Y-%m-%d %H:%M:%S')"
