# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  LAZY_LOCK: '${XDG_CONFIG_HOME:-$HOME/.config}/nvim/lazy-lock.json'
  LAZY_LOCK_REPO: 'packages/nvim/.config/nvim/lazy-lock.json'

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  restore:
    desc: Restore Neovim plugins to the state in lazy-lock.json
    summary: |
      Restores Neovim plugins to the state specified in lazy-lock.json
      Useful for bootstrapping a fresh machine or after cloning dotfiles

      Skips if plugins are already at the correct versions (checks lazy-lock.json hash)
    vars:
      NVIM_DATA: '${XDG_DATA_HOME:-$HOME/.local/share}/nvim'
      LAZY_LOCK_HASH:
        sh: test -f "{{.LAZY_LOCK}}" && shasum -a 256 "{{.LAZY_LOCK}}" | cut -d' ' -f1 || echo ""
      LAST_RESTORE_HASH:
        sh: test -f "{{.NVIM_DATA}}/.lazy-restore-hash" && cat "{{.NVIM_DATA}}/.lazy-restore-hash" || echo ""
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed. Run 'brew install neovim' first"
      - sh: test -f "{{.LAZY_LOCK}}"
        msg: "lazy-lock.json not found at {{.LAZY_LOCK}}"
    status:
      # Skip if lazy-lock.json hasn't changed since last restore
      - test -n "{{.LAZY_LOCK_HASH}}" && test "{{.LAZY_LOCK_HASH}}" = "{{.LAST_RESTORE_HASH}}"
    cmds:
      - echo "ðŸ“¦ Installing Neovim plugins (this may take a few minutes)..."
      # Ensure lazy.nvim is installed first
      - |
        LAZY_PATH="${XDG_DATA_HOME:-$HOME/.local/share}/nvim/lazy/lazy.nvim"
        if [[ ! -d "$LAZY_PATH" ]]; then
          echo "  â†’ Bootstrapping lazy.nvim..."
          git clone --filter=blob:none https://github.com/folke/lazy.nvim.git --branch=stable "$LAZY_PATH"
        fi
      # Step 1: Restore plugins from lock file (plugins not loaded yet)
      - |
        echo "  â†’ Restoring plugins from lazy-lock.json..."
        nvim --headless +'Lazy! restore' +'qa' 2>&1 || true
      # Step 2: Clean unused plugins
      - |
        echo "  â†’ Cleaning unused plugins..."
        nvim --headless +'Lazy! clean' +'qa' 2>&1 || true
      # Step 3: Update TreeSitter parsers (plugins now loaded)
      - |
        echo "  â†’ Installing TreeSitter parsers..."
        timeout 120 nvim --headless +'TSUpdateSync' +'qa' 2>&1 || true
      # Step 4: Install Mason packages via mason-tool-installer
      # First run may not have the plugin yet, so we check and skip if needed
      - |
        echo "  â†’ Installing Mason packages (this may take a while)..."
        timeout 300 nvim --headless \
          +'lua if pcall(require, "mason-tool-installer") then vim.cmd("autocmd User MasonToolsUpdateCompleted qall!") vim.cmd("MasonToolsInstall") else print("mason-tool-installer not yet installed, skipping...") vim.cmd("qa") end' \
          2>&1 || true
      - mkdir -p "{{.NVIM_DATA}}"
      - echo "{{.LAZY_LOCK_HASH}}" > "{{.NVIM_DATA}}/.lazy-restore-hash"
      - echo "âœ“ Neovim plugins installed"

  update:
    desc: Update Neovim plugins, CLI utils, and TreeSitter
    summary: |
      Updates Neovim plugins, CLI utils, and TreeSitter plugins
      Automatically commits changes to lazy-lock.json if there are any
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed"
    cmds:
      - echo "ðŸ“¦ Updating Neovim plugins..."
      # Step 1: Sync plugins (update to latest)
      - |
        echo "  â†’ Syncing plugins..."
        nvim --headless +'Lazy! sync' +'qa' 2>&1 || true
      # Step 2: Clean unused plugins
      - |
        echo "  â†’ Cleaning unused plugins..."
        nvim --headless +'Lazy! clean' +'qa' 2>&1 || true
      # Step 3: Update TreeSitter parsers
      - |
        echo "  â†’ Updating TreeSitter parsers..."
        timeout 120 nvim --headless +'TSUpdateSync' +'qa' 2>&1 || true
      # Step 4: Update Mason packages via mason-tool-installer
      - |
        echo "  â†’ Updating Mason packages..."
        timeout 300 nvim --headless \
          +'lua if pcall(require, "mason-tool-installer") then vim.cmd("autocmd User MasonToolsUpdateCompleted qall!") vim.cmd("MasonToolsUpdate") else print("mason-tool-installer not installed") vim.cmd("qa") end' \
          2>&1 || true
      - task: commit

  check:
    desc: Verify Neovim setup and configuration
    summary: |
      Runs health checks to verify Neovim is properly configured
      Useful for debugging issues after fresh install
    cmds:
      - task: health

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  health:
    desc: Run Neovim health checks
    internal: true
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed"
    cmds:
      - echo "ðŸ” Running Neovim health checks..."
      - |
        # Run checkhealth and filter for relevant output
        output=$(nvim --headless +'checkhealth' +qa 2>&1 || true)
        errors=$(echo "$output" | grep -c 'ERROR' || echo "0")
        warnings=$(echo "$output" | grep -c 'WARN' || echo "0")

        # Show errors and warnings if any
        if [[ "$errors" -gt 0 ]] || [[ "$warnings" -gt 0 ]]; then
          echo "$output" | grep -E '(ERROR|WARN|^==)' | head -50
          echo ""
          echo "ðŸ“Š Summary: $errors error(s), $warnings warning(s)"
          echo "   Run 'nvim +checkhealth' for full details"
        else
          echo "âœ“ No errors or warnings found"
        fi

  commit:
    desc: Commit lazy-lock.json if changed
    internal: true
    preconditions:
      - sh: test -f ./scripts/commit_changed_file.sh
        msg: "commit script not found at ./scripts/commit_changed_file.sh"
    cmds:
      - |
        ./scripts/commit_changed_file.sh \
          '{{.LAZY_LOCK_REPO}}' \
          "chore(nvim): update plugins $(date '+%Y-%m-%d %H:%M:%S')"
