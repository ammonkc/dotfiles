# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  LAZY_LOCK: './packages/nvim/.config/nvim/lazy-lock.json'

tasks:
  health:
    desc: Run Neovim health checks
    internal: true
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed"
    cmds:
      - nvim --headless +'checkhealth' +qa

  restore:
    desc: Restore Neovim plugins to the state in lazy-lock.json
    summary: |
      Restores Neovim plugins to the state specified in lazy-lock.json
      Useful for bootstrapping a fresh machine or after cloning dotfiles
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed. Run 'brew install neovim' first"
      - sh: test -f "{{.LAZY_LOCK}}"
        msg: "lazy-lock.json not found at {{.LAZY_LOCK}}"
    deps:
      - health
    cmds:
      - |
        nvim --headless \
          +'Lazy! restore' \
          +'Lazy! clean' \
          +'TSUpdateSync' \
          +'autocmd User MasonUpdateAllCompleted qall!' \
          +'MasonUpdateAll'

  update:
    desc: Update Neovim plugins, CLI utils, and TreeSitter
    summary: |
      Updates Neovim plugins, CLI utils, and TreeSitter plugins
      Automatically commits changes to lazy-lock.json if there are any
    preconditions:
      - sh: command -v nvim >/dev/null 2>&1
        msg: "Neovim is not installed"
    deps:
      - health
    cmds:
      - |
        nvim --headless \
          +'Lazy! sync' \
          +'Lazy! clean' \
          +'TSUpdateSync' \
          +'autocmd User MasonUpdateAllCompleted qall!' \
          +'MasonUpdateAll'
      - task: commit

  commit:
    desc: Commit lazy-lock.json if changed
    internal: true
    preconditions:
      - sh: test -f ./scripts/commit_changed_file.sh
        msg: "commit script not found at ./scripts/commit_changed_file.sh"
    cmds:
      - |
        ./scripts/commit_changed_file.sh \
          '{{.LAZY_LOCK}}' \
          "chore(nvim): update plugins $(date '+%Y-%m-%d %H:%M:%S')"

  check:
    desc: Verify Neovim setup and configuration
    summary: |
      Runs health checks to verify Neovim is properly configured
      Useful for debugging issues after fresh install
    cmds:
      - task: health
