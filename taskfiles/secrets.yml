# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  HOME: '{{env "HOME"}}'
  GITCONFIG_LOCAL: '{{.HOME}}/.gitconfig.local'
  ENV_LOCAL: '{{.HOME}}/.env.local'
  SSH_CONFIG_LOCAL: '{{.HOME}}/.ssh/config'
  SECRETS_MARKER: "# --- 1Password secrets (do not edit below) ---"

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  setup:
    desc: Setup local secrets from 1Password
    summary: |
      Retrieves secrets from 1Password and sets up local config files:
      - ~/.gitconfig.local (git/github credentials)
      - ~/.env.local (environment variables)

      Requires 1Password CLI to be installed and authenticated.
    platforms: [darwin]
    preconditions:
      - sh: command -v op >/dev/null 2>&1
        msg: |
          1Password CLI is not installed.
          Run: brew install --cask 1password-cli
      - sh: op account list >/dev/null 2>&1
        msg: |
          Not signed in to 1Password CLI.
          Run: op signin
    cmds:
      - task: setup:gitconfig_local
      - task: setup:env_local
      - task: setup:ssh_config_local

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  setup:gitconfig_local:
    desc: Append 1Password secrets to ~/.gitconfig.local
    internal: true
    platforms: [darwin]
    status:
      - grep -qF "{{.SECRETS_MARKER}}" "{{.GITCONFIG_LOCAL}}" 2>/dev/null
    cmds:
      - echo "" >> "{{.GITCONFIG_LOCAL}}"
      - echo "{{.SECRETS_MARKER}}" >> "{{.GITCONFIG_LOCAL}}"
      - op read "op://Private/.gitconfig.local/file" >> "{{.GITCONFIG_LOCAL}}"

  setup:env_local:
    desc: Append 1Password secrets to ~/.env.local
    internal: true
    platforms: [darwin]
    status:
      - grep -qF "{{.SECRETS_MARKER}}" "{{.ENV_LOCAL}}" 2>/dev/null
    cmds:
      - echo "" >> "{{.ENV_LOCAL}}"
      - echo "{{.SECRETS_MARKER}}" >> "{{.ENV_LOCAL}}"
      - op read "op://Private/.env.local/file" >> "{{.ENV_LOCAL}}"

  setup:ssh_config_local:
    desc: Append 1Password secrets to ~/.ssh/config
    internal: true
    platforms: [darwin]
    status:
      - grep -qF "{{.SECRETS_MARKER}}" "{{.SSH_CONFIG_LOCAL}}" 2>/dev/null
    cmds:
      - echo "" >> "{{.SSH_CONFIG_LOCAL}}"
      - echo "{{.SECRETS_MARKER}}" >> "{{.SSH_CONFIG_LOCAL}}"
      - op read "op://Private/ssh_config.local/file" >> "{{.SSH_CONFIG_LOCAL}}"

  refresh:
    desc: Force refresh all secrets from 1Password
    summary: |
      Removes existing 1Password secrets section and re-downloads from 1Password.
      Use this if your 1Password secrets have been updated.

      Note: Only removes the "# --- 1Password secrets" section, preserves other content.
    platforms: [darwin]
    preconditions:
      - sh: command -v op >/dev/null 2>&1
        msg: "1Password CLI is not installed"
      - sh: op account list >/dev/null 2>&1
        msg: "Not signed in to 1Password CLI"
    cmds:
      - echo "ðŸ”„ Refreshing secrets from 1Password..."
      # Remove existing 1Password sections (everything from marker to end of file)
      - |
        if grep -qF "{{.SECRETS_MARKER}}" "{{.GITCONFIG_LOCAL}}" 2>/dev/null; then
          sed -i '' '/{{.SECRETS_MARKER}}/,$d' "{{.GITCONFIG_LOCAL}}"
          echo "  â†’ Removed old secrets from {{.GITCONFIG_LOCAL}}"
        fi
      - |
        if grep -qF "{{.SECRETS_MARKER}}" "{{.ENV_LOCAL}}" 2>/dev/null; then
          sed -i '' '/{{.SECRETS_MARKER}}/,$d' "{{.ENV_LOCAL}}"
          echo "  â†’ Removed old secrets from {{.ENV_LOCAL}}"
        fi
      - task: setup
      - echo "âœ“ All secrets refreshed"
