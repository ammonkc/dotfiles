# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  HOME: '{{env "HOME"}}'
  OP_ACCOUNT: 'my.1password.com'
  GITCONFIG_LOCAL: '{{.HOME}}/.gitconfig.local'
  ENV_LOCAL: '{{.HOME}}/.env.local'
  SSH_CONFIG_LOCAL: '{{.HOME}}/.ssh/config'
  SECRETS_MARKER: "# --- 1Password secrets (do not edit below) ---"

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  install:
    desc: Install local secrets from 1Password
    summary: |
      Retrieves secrets from 1Password and appends to local config files:
      - ~/.gitconfig.local (git/github credentials from personal account)
      - ~/.env.local (environment variables)
      - ~/.ssh/config (SSH host configurations)
      - ~/.gitconfig.<work>.local (user info for each business account)

      Skips files that already have secrets installed.
      Requires 1Password CLI to be installed and authenticated.
    platforms: [darwin]
    preconditions:
      - sh: command -v op >/dev/null 2>&1
        msg: |
          1Password CLI is not installed.
          Run: brew install --cask 1password-cli
      - sh: op account list >/dev/null 2>&1
        msg: |
          Not signed in to 1Password CLI.
          Run: op signin
    cmds:
      - task: install:gitconfig_local
      - task: install:env_local
      - task: install:ssh_config_local
      - task: install:work_gitconfigs

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  install:gitconfig_local:
    desc: Add [user] and [github] sections to ~/.gitconfig.local from 1Password
    internal: true
    platforms: [darwin]
    status:
      - grep -qF "{{.SECRETS_MARKER}}" "{{.GITCONFIG_LOCAL}}" 2>/dev/null
    cmds:
      - |
        set -e  # Exit on first error

        # Get user info from 1Password account
        USER_INFO=$(op user get --me --account {{.OP_ACCOUNT}} --format=json)
        USER_EMAIL=$(echo "$USER_INFO" | jq -r '.email')
        USER_NAME=$(echo "$USER_INFO" | jq -r '.name')
        SIGNING_KEY=$(op item get "id_ed25519" --account {{.OP_ACCOUNT}} --fields label="public key")

        # Get GitHub credentials from 1Password
        GH_USER=$(op item get "github" --account {{.OP_ACCOUNT}} --fields label=username)
        GH_TOKEN=$(op item get "github" --account {{.OP_ACCOUNT}} --fields label=token)

        # Append to gitconfig.local
        {
          echo ""
          echo "{{.SECRETS_MARKER}}"
          echo "[user]"
          echo "  name = ${USER_NAME}"
          echo "  email = ${USER_EMAIL}"
          echo "  signingkey = ${SIGNING_KEY}"
          echo ""
          echo "[github]"
          echo "  user = ${GH_USER}"
          echo "  token = ${GH_TOKEN}"
        } >> "{{.GITCONFIG_LOCAL}}"
      - |
        # Append additional config from 1Password document if it exists
        if op document get ".gitconfig.local" --account {{.OP_ACCOUNT}} >/dev/null 2>&1; then
          echo "" >> "{{.GITCONFIG_LOCAL}}"
          op document get ".gitconfig.local" --account {{.OP_ACCOUNT}} >> "{{.GITCONFIG_LOCAL}}"
        fi
      - echo "âœ“ Added secrets from 1Password to {{.GITCONFIG_LOCAL}}"

  install:env_local:
    desc: Append 1Password secrets to ~/.env.local
    internal: true
    platforms: [darwin]
    status:
      - grep -qF "{{.SECRETS_MARKER}}" "{{.ENV_LOCAL}}" 2>/dev/null
    cmds:
      - |
        # Append env secrets from 1Password document if it exists
        if op document get ".env.local" --account {{.OP_ACCOUNT}} >/dev/null 2>&1; then
          echo "" >> "{{.ENV_LOCAL}}"
          echo "{{.SECRETS_MARKER}}" >> "{{.ENV_LOCAL}}"
          op document get ".env.local" --account {{.OP_ACCOUNT}} >> "{{.ENV_LOCAL}}"
          echo "âœ“ Added secrets from 1Password to {{.ENV_LOCAL}}"
        else
          echo "âš  No .env.local document found in 1Password, skipping"
        fi

  install:ssh_config_local:
    desc: Append 1Password secrets to ~/.ssh/config
    internal: true
    platforms: [darwin]
    status:
      - grep -qF "{{.SECRETS_MARKER}}" "{{.SSH_CONFIG_LOCAL}}" 2>/dev/null
    cmds:
      - |
        set -e  # Exit on first error

        # Get GitHub username from 1Password
        GH_USERNAME=$(op item get "github" --account {{.OP_ACCOUNT}} --fields label=username)

        # Create GitHub host config block
        GH_HOST="Host *.github.com
          User ${GH_USERNAME}"

        # Prepend GitHub host to existing config (using temp file to avoid truncation)
        TMPFILE=$(mktemp)
        echo "$GH_HOST" > "$TMPFILE"
        echo "" >> "$TMPFILE"
        cat "{{.SSH_CONFIG_LOCAL}}" >> "$TMPFILE"
        mv "$TMPFILE" "{{.SSH_CONFIG_LOCAL}}"
      - |
        # Append SSH config secrets from 1Password document if it exists
        if op document get "ssh_config.local" --account {{.OP_ACCOUNT}} >/dev/null 2>&1; then
          echo "" >> "{{.SSH_CONFIG_LOCAL}}"
          echo "{{.SECRETS_MARKER}}" >> "{{.SSH_CONFIG_LOCAL}}"
          op document get "ssh_config.local" --account {{.OP_ACCOUNT}} >> "{{.SSH_CONFIG_LOCAL}}"
        fi
      - echo "âœ“ Added secrets from 1Password to {{.SSH_CONFIG_LOCAL}}"

  install:work_gitconfigs:
    desc: Create gitconfig files for business 1Password accounts
    internal: true
    platforms: [darwin]
    cmds:
      - |
        set -e  # Exit on first error

        # Get all 1Password accounts except personal
        ACCOUNTS=$(op account list --format=json | jq -r '.[] | select(.url != "{{.OP_ACCOUNT}}") | .url')

        if [ -z "$ACCOUNTS" ]; then
          echo "âš  No business accounts found, skipping work gitconfigs"
          exit 0
        fi

        for ACCOUNT in $ACCOUNTS; do
          # Get user info from business account
          USER_INFO=$(op user get --me --account "$ACCOUNT" --format=json)
          USER_EMAIL=$(echo "$USER_INFO" | jq -r '.email')
          USER_NAME=$(echo "$USER_INFO" | jq -r '.name')

          # Extract work name from email domain (e.g., "ammon@acme.com" -> "acme")
          WORK_NAME=$(echo "$USER_EMAIL" | sed 's/.*@//' | sed 's/\..*//')
          GITCONFIG_FILE="{{.HOME}}/.gitconfig.${WORK_NAME}.local"

          # Skip if file already has secrets marker
          if grep -qF "{{.SECRETS_MARKER}}" "$GITCONFIG_FILE" 2>/dev/null; then
            echo "  â†’ $GITCONFIG_FILE already configured, skipping"
            continue
          fi

          # Create gitconfig file
          {
            echo "# Work gitconfig for ${WORK_NAME}"
            echo "{{.SECRETS_MARKER}}"
            echo "[user]"
            echo "  name = ${USER_NAME}"
            echo "  email = ${USER_EMAIL}"
          } > "$GITCONFIG_FILE"

          echo "âœ“ Created $GITCONFIG_FILE"
        done

  refresh:
    desc: Force refresh all secrets from 1Password
    summary: |
      Removes existing 1Password secrets section and re-downloads from 1Password.
      Use this if your 1Password secrets have been updated.

      Note: Only removes the "# --- 1Password secrets" section, preserves other content.
    platforms: [darwin]
    preconditions:
      - sh: command -v op >/dev/null 2>&1
        msg: "1Password CLI is not installed"
      - sh: op account list >/dev/null 2>&1
        msg: "Not signed in to 1Password CLI"
    cmds:
      - echo "ðŸ”„ Refreshing secrets from 1Password..."
      # Remove existing 1Password sections (everything from marker to end of file)
      - |
        if grep -qF "{{.SECRETS_MARKER}}" "{{.GITCONFIG_LOCAL}}" 2>/dev/null; then
          sed -i '' '/{{.SECRETS_MARKER}}/,$d' "{{.GITCONFIG_LOCAL}}"
          echo "  â†’ Removed old secrets from {{.GITCONFIG_LOCAL}}"
        fi
      - |
        if grep -qF "{{.SECRETS_MARKER}}" "{{.ENV_LOCAL}}" 2>/dev/null; then
          sed -i '' '/{{.SECRETS_MARKER}}/,$d' "{{.ENV_LOCAL}}"
          echo "  â†’ Removed old secrets from {{.ENV_LOCAL}}"
        fi
      - |
        if grep -qF "{{.SECRETS_MARKER}}" "{{.SSH_CONFIG_LOCAL}}" 2>/dev/null; then
          sed -i '' '/{{.SECRETS_MARKER}}/,$d' "{{.SSH_CONFIG_LOCAL}}"
          echo "  â†’ Removed old secrets from {{.SSH_CONFIG_LOCAL}}"
        fi
      - task: install
      - echo "âœ“ All secrets refreshed"
