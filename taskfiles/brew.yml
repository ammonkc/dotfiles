# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  DOTFILES: "{{.ROOT_DIR}}"

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  install:
    platforms: [darwin]
    desc: Install Homebrew and tools defined in Brewfile
    cmds:
      - task: install:homebrew
      - task: install:tools

  upgrade:
    platforms: [darwin]
    desc: Update Homebrew and upgrade all installed packages
    cmds:
      - brew update
      - brew upgrade
      - task: update

  update:
    platforms: [darwin]
    desc: Update Brewfile with current brew packages and commit changes
    cmds:
      - task: update_no_commit
      - task: commit

  cleanup:
    desc: Remove unused brew dependencies
    platforms: [darwin]
    cmds:
      - brew cleanup
      - brew autoremove

  retry:
    desc: Retry failed Homebrew package installations
    summary: |
      Retries installing packages from Brewfile
      Useful after network failures or interrupted installations
    platforms: [darwin]
    dir: "/{{.DOTFILES}}"
    cmds:
      - echo "üîÑ Retrying Homebrew package installation..."
      - brew bundle
      - echo "‚úì Installation complete"

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  install:homebrew:
    internal: true
    platforms: [darwin]
    status:
      - which brew
    cmds:
      - NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - |
        # Add Homebrew to PATH for current session
        echo "Adding Homebrew to PATH..."
        if [[ $(uname -m) == "arm64" ]]; then
          eval "$(/opt/homebrew/bin/brew shellenv)"
        else
          eval "$(/usr/local/bin/brew shellenv)"
        fi

  install:tools:
    internal: true
    platforms: [darwin]
    # NOTE: the leading slash here is a bit annoying, but required due to a bug
    # in go-task see https://github.com/go-task/task/issues/828
    dir: "/{{.DOTFILES}}"
    deps:
      - install:homebrew
    cmds:
      - echo "üì¶ Installing Homebrew packages from Brewfile..."
      - task: install:tools:attempt
        vars: {ATTEMPT: 1}
      - echo "‚úì Homebrew packages installed successfully"

  install:tools:attempt:
    internal: true
    platforms: [darwin]
    dir: "/{{.DOTFILES}}"
    vars:
      ATTEMPT: '{{.ATTEMPT | default "1"}}'
      MAX_ATTEMPTS: 3
    cmds:
      - cmd: brew bundle
        ignore_error: true
      - task: install:tools:retry
        vars:
          ATTEMPT: '{{.ATTEMPT}}'
          MAX_ATTEMPTS: '{{.MAX_ATTEMPTS}}'

  install:tools:retry:
    internal: true
    platforms: [darwin]
    dir: "/{{.DOTFILES}}"
    vars:
      ATTEMPT: '{{.ATTEMPT}}'
      MAX_ATTEMPTS: '{{.MAX_ATTEMPTS}}'
      NEXT_ATTEMPT:
        sh: echo $(({{.ATTEMPT}} + 1))
    status:
      # Check if brew bundle succeeded (no .Brewfile.lock.json.failed marker)
      - brew bundle check
    preconditions:
      - sh: test {{.ATTEMPT}} -lt {{.MAX_ATTEMPTS}}
        msg: |
          ‚ùå Installation failed after {{.MAX_ATTEMPTS}} attempts
          üí° This is likely a temporary network issue with ghcr.io
          üí° You can try running 'task brew:install' again later
    cmds:
      - echo "‚ö†Ô∏è  Installation failed (attempt {{.ATTEMPT}}/{{.MAX_ATTEMPTS}})"
      - echo "‚è≥ Waiting 10 seconds before retry..."
      - sleep 10
      - echo "üîÑ Retrying brew bundle..."
      - task: install:tools:attempt
        vars:
          ATTEMPT: '{{.NEXT_ATTEMPT}}'

  update_no_commit:
    internal: true
    platforms: [darwin]
    # NOTE: the leading slash here is a bit annoying, but required due to a bug
    # in go-task see https://github.com/go-task/task/issues/828
    dir: "/{{.DOTFILES}}"
    cmds:
      - brew bundle dump --force --describe

  commit:
    desc: Commits the Brewfile file if changed
    internal: true
    silent: true
    cmd: |
      ./scripts/commit_changed_file.sh \
        'Brewfile' \
        "chore(brew): update packages $(date '+%Y-%m-%d %H:%M:%S')"
