# taskfiles/dotfiles.yml
version: 3

includes:
  backup:
    taskfile: ./backup.yml
    internal: true

vars:
  DOTFILES_DIR: '{{.ROOT_DIR}}'
  PACKAGES_DIR: '{{.DOTFILES_DIR}}/packages'
  STOW_FLAGS: '--verbose --restow --no-folding'
  # Dynamically get list of all package directories
  PACKAGES:
    sh: cd {{.PACKAGES_DIR}} && find . -maxdepth 1 -type d ! -name ".*" -exec basename {} \; | sort
  # Dynamically find all .local template files in packages
  LOCAL_FILES:
    sh: cd {{.PACKAGES_DIR}} && find . -type f -name "*.local" | sed 's|^\./||'

tasks:
  install:
    desc: Install all dotfiles using GNU Stow
    cmds:
      - task: ensure_dirs
      - task: stow:packages
      - task: copy_local_configs

  ensure_dirs:
    internal: true
    cmds:
      - mkdir -p ~/.config
      - mkdir -p ~/.ssh
      - mkdir -p ~/.local/{bin,share}

  stow:packages:
    internal: true
    desc: Stow all packages
    cmds:
      - echo "ðŸ“¦ Stowing packages from {{.PACKAGES_DIR}}..."
      - for:
          var: PACKAGES
          as: PACKAGE
        task: stow:package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  stow:package:
    internal: true
    vars:
      PACKAGE: '{{.PACKAGE}}'
    dir: '{{.PACKAGES_DIR}}'
    cmds:
      - echo "  â†’ Stowing {{.PACKAGE}}..."
      - task: backup:backup_conflicts
        vars:
          PACKAGE: '{{.PACKAGE}}'
          PACKAGES_DIR: '{{.PACKAGES_DIR}}'
          STOW_FLAGS: '{{.STOW_FLAGS}}'
      - stow {{.STOW_FLAGS}} -t $HOME "{{.PACKAGE}}"

  unstow:packages:
    internal: true
    desc: Unstow all packages
    cmds:
      - echo "ðŸ“¦ Unstowing packages from {{.PACKAGES_DIR}}..."
      - for:
          var: PACKAGES
          as: PACKAGE
        task: unstow:package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  unstow:package:
    internal: true
    vars:
      PACKAGE: '{{.PACKAGE}}'
    dir: '{{.PACKAGES_DIR}}'
    cmds:
      - echo "  â†’ Unstowing {{.PACKAGE}}..."
      - stow --verbose --delete -t $HOME "{{.PACKAGE}}"
      - task: backup:restore_latest_package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  uninstall:
    desc: Remove dotfile symlinks
    cmds:
      - task: unstow:packages

  list:
    desc: List all available packages
    silent: true
    cmds:
      - echo "ðŸ“¦ Available packages:"
      - for:
          var: PACKAGES
          as: PACKAGE
        cmd: echo "  - {{.PACKAGE}}"

  restow:
    desc: Restow a specific package
    summary: |
      Restow a specific package by name
      Usage: task dot:restow PACKAGE=zsh
    vars:
      PACKAGE: '{{.PACKAGE | default ""}}'
    dir: '{{.PACKAGES_DIR}}'
    preconditions:
      - sh: test -n "{{.PACKAGE}}"
        msg: "PACKAGE variable is required. Usage: task dot:restow PACKAGE=zsh"
      - sh: test -d "{{.PACKAGES_DIR}}/{{.PACKAGE}}"
        msg: "Package '{{.PACKAGE}}' not found in {{.PACKAGES_DIR}}"
    cmds:
      - echo "ðŸ”„ Restowing {{.PACKAGE}}..."
      - stow {{.STOW_FLAGS}} -t $HOME "{{.PACKAGE}}"
      - echo "âœ“ {{.PACKAGE}} restowed successfully"

  copy_local_configs:
    internal: true
    desc: Copy .local template files from packages to $HOME if they don't exist
    cmds:
      - for:
          var: LOCAL_FILES
          as: LOCAL_FILE
        task: copy_local_file
        vars:
          LOCAL_FILE: '{{.LOCAL_FILE}}'

  copy_local_file:
    internal: true
    vars:
      LOCAL_FILE: '{{.LOCAL_FILE}}'
      # Extract just the filename (e.g., "zsh/.config/zsh/env.local" -> "env.local")
      FILENAME:
        sh: basename "{{.LOCAL_FILE}}"
      # Always copy to $HOME root with leading dot (e.g., "$HOME/.env.local")
      DEST_FILE: '$HOME/.{{.FILENAME}}'
    status:
      - test -f "{{.DEST_FILE}}"
    cmds:
      - echo "Copying {{.FILENAME}} to {{.DEST_FILE}}..."
      - cp "{{.PACKAGES_DIR}}/{{.LOCAL_FILE}}" "{{.DEST_FILE}}"
      - echo "âœ“ Created {{.DEST_FILE}} - please customize it"
