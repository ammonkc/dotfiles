# taskfiles/dotfiles.yml
version: 3

includes:
  brew:
    taskfile: ./brew.yml
    internal: true

  backup:
    taskfile: ./backup.yml
    internal: true

vars:
  DOTFILES_DIR: '{{.ROOT_DIR}}'
  PACKAGES_DIR: '{{.DOTFILES_DIR}}/packages'
  STOW_FLAGS: '--restow --no-folding'
  # Determine Homebrew prefix based on architecture (for macOS)
  BREW_PREFIX:
    sh: |
      if [[ "$(uname)" == "Darwin" ]]; then
        if [[ $(uname -m) == "arm64" ]]; then
          echo "/opt/homebrew"
        else
          echo "/usr/local"
        fi
      else
        echo ""
      fi
  # Dynamically get list of all package directories
  PACKAGES:
    sh: cd {{.PACKAGES_DIR}} && find . -maxdepth 1 -type d ! -name ".*" -exec basename {} \; | sort
  # Dynamically find all .local and *.local.* template files in packages
  LOCAL_FILES:
    sh: cd {{.PACKAGES_DIR}} && find . -type f \( -name "*.local" -o -name "*.local.*" \) | sed 's|^\./||'

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  install:
    desc: Install all dotfiles using GNU Stow
    cmds:
      - task: ensure_dirs
      - task: stow:packages
      - task: copy_local_configs

  uninstall:
    desc: Remove dotfile symlinks
    cmds:
      - task: unstow:packages

  list:
    desc: List all available packages
    silent: true
    cmds:
      - echo "üì¶ Available packages:"
      - for:
          var: PACKAGES
          as: PACKAGE
        cmd: echo "  - {{.PACKAGE}}"

  restow:
    desc: Restow a specific package
    summary: |
      Restow a specific package by name
      Usage: task dot:restow PACKAGE=zsh
    vars:
      PACKAGE: '{{.PACKAGE | default ""}}'
    preconditions:
      - sh: test -n "{{.PACKAGE}}"
        msg: "PACKAGE variable is required. Usage: task dot:restow PACKAGE=zsh"
      - sh: test -d "{{.PACKAGES_DIR}}/{{.PACKAGE}}"
        msg: "Package '{{.PACKAGE}}' not found in {{.PACKAGES_DIR}}"
    cmds:
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        stow {{.STOW_FLAGS}} --dir={{.PACKAGES_DIR}} -t $HOME "{{.PACKAGE}}"

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  ensure_dirs:
    internal: true
    silent: true
    cmds:
      - mkdir -p ~/.config
      - mkdir -p ~/.ssh
      - mkdir -p ~/.local/{bin,share}

  stow:packages:
    internal: true
    silent: true
    desc: Stow all packages
    preconditions:
      - sh: |
          {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
          command -v stow >/dev/null 2>&1
        msg: "stow is not installed. Run 'task system:install' first to install it, or install stow manually (e.g., 'brew install stow' on macOS or 'sudo apt-get install stow' on Linux)."
    cmds:
      - echo "Stowing packages from {{.PACKAGES_DIR}}..."
      - for:
          var: PACKAGES
          as: PACKAGE
        task: stow:package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  stow:package:
    internal: true
    silent: true
    vars:
      PACKAGE: '{{.PACKAGE}}'
    cmds:
      - echo "  ‚Üí Stowing {{.PACKAGE}}..."
      - task: backup:backup_conflicts
        vars:
          PACKAGE: '{{.PACKAGE}}'
          PACKAGES_DIR: '{{.PACKAGES_DIR}}'
          STOW_FLAGS: '{{.STOW_FLAGS}}'
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        stow {{.STOW_FLAGS}} --dir={{.PACKAGES_DIR}} -t $HOME "{{.PACKAGE}}"

  unstow:packages:
    internal: true
    silent: true
    desc: Unstow all packages
    cmds:
      - for:
          var: PACKAGES
          as: PACKAGE
        task: unstow:package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  unstow:package:
    internal: true
    silent: true
    vars:
      PACKAGE: '{{.PACKAGE}}'
    cmds:
      - echo "  ‚Üí Unstowing {{.PACKAGE}}..."
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        stow --delete --dir={{.PACKAGES_DIR}} -t $HOME "{{.PACKAGE}}"
      - task: backup:restore_latest_package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  copy_local_configs:
    internal: true
    silent: true
    desc: Copy .local template files from packages to $HOME if they don't exist
    cmds:
      - for:
          var: LOCAL_FILES
          as: LOCAL_FILE
        task: copy_local_file
        vars:
          LOCAL_FILE: '{{.LOCAL_FILE}}'
      - task: copy_local_ssh_config

  copy_local_file:
    internal: true
    silent: true
    vars:
      LOCAL_FILE: '{{.LOCAL_FILE}}'
      # Extract just the filename (e.g., "zsh/.config/zsh/env.local" -> "env.local")
      FILENAME:
        sh: basename "{{.LOCAL_FILE}}"
      # Always copy to $HOME root with leading dot (e.g., "$HOME/.env.local")
      DEST_FILE: '$HOME/.{{.FILENAME}}'
    status:
      - test -f "{{.DEST_FILE}}"
    cmds:
      - echo "Copying {{.FILENAME}} to {{.DEST_FILE}}..."
      - cp "{{.PACKAGES_DIR}}/{{.LOCAL_FILE}}" "{{.DEST_FILE}}"
      - echo "‚úì Created {{.DEST_FILE}} - please customize it"

  copy_local_ssh_config:
    internal: true
    silent: true
    vars:
      SSH_CONFIG_LOCAL: '{{.PACKAGES_DIR}}/ssh/.config/ssh/ssh_config_local'
      DEST_FILE: '$HOME/.ssh/config'
    status:
      - test -f "{{.DEST_FILE}}"
    cmds:
      - cp "{{.SSH_CONFIG_LOCAL}}" "{{.DEST_FILE}}"
      - chmod 600 "{{.DEST_FILE}}"
      - chmod 700 "$HOME/.ssh"
      - echo "‚úì Created {{.DEST_FILE}} - please customize it"

  # ============================================================================
  # Raycast Extension Tasks
  # ============================================================================

  raycast:extension:
    desc: Install and register Raycast IDL Docker extension
    summary: |
      Installs npm dependencies and registers the IDL Docker extension with Raycast.
      Run this after stowing dotfiles on a new machine.
    dir: '{{.PACKAGES_DIR}}/raycast/extensions/idl-docker'
    preconditions:
      - sh: command -v npm >/dev/null 2>&1
        msg: "npm is not installed. Install Node.js first."
      - sh: test -d "{{.PACKAGES_DIR}}/raycast/extensions/idl-docker"
        msg: "Raycast extension not found at {{.PACKAGES_DIR}}/raycast/extensions/idl-docker"
    cmds:
      - echo "üì¶ Installing Raycast IDL Docker extension..."
      - npm install
      - echo "üöÄ Registering extension with Raycast..."
      - npm run dev &
      - sleep 3
      - echo "‚úì Extension registered! You can now use 'IDL Docker' commands in Raycast"

  # ============================================================================
  # Health Check / Doctor Tasks
  # ============================================================================

  doctor:
    desc: Check dotfiles health and integrity
    summary: |
      Runs comprehensive checks on dotfiles:
      - Verifies stowed symlinks point to correct locations
      - Finds broken symlinks in home directory
      - Checks for required directories
      - Validates .local template files exist

      Run this if something seems wrong with your dotfiles
    cmds:
      - task: doctor:symlinks
      - task: doctor:broken_links
      - task: doctor:directories
      - task: doctor:templates

  doctor:symlinks:
    desc: Check stowed symlinks integrity
    internal: true
    silent: true
    vars:
      STOWED_COUNT:
        sh: find ~ -maxdepth 3 -type l -lname "*/.dotfiles/*" 2>/dev/null | wc -l | tr -d ' '
    cmds:
      - echo "üîç Checking stowed symlinks..."
      - |
        if [[ "{{.STOWED_COUNT}}" -eq 0 ]]; then
          echo "‚ö†Ô∏è  No dotfiles symlinks found - run 'task dot:install' first"
        else
          echo "‚úì Found {{.STOWED_COUNT}} stowed symlink(s)"
        fi

  doctor:broken_links:
    desc: Check for broken symlinks
    internal: true
    silent: true
    cmds:
      - echo "üîç Checking for broken symlinks..."
      - |
        BROKEN=$(find ~ -maxdepth 3 -type l ! -exec test -e {} \; -print 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$BROKEN" -eq 0 ]]; then
          echo "‚úì No broken symlinks found"
        else
          echo "‚ö†Ô∏è  Found $BROKEN broken symlink(s) - run 'task clean:dead_symlinks' for details"
        fi

  doctor:directories:
    desc: Check required directories exist
    internal: true
    silent: true
    cmds:
      - echo "üîç Checking required directories..."
      - |
        MISSING=0
        for dir in ~/.config ~/.ssh ~/.local/bin ~/.local/share; do
          if [[ ! -d "$dir" ]]; then
            echo "  ‚úó Missing: $dir"
            MISSING=$((MISSING + 1))
          fi
        done
        if [[ $MISSING -eq 0 ]]; then
          echo "‚úì All required directories exist"
        else
          echo "‚ö†Ô∏è  $MISSING director(ies) missing - run 'task dot:install' to create them"
        fi

  doctor:templates:
    desc: Verify .local template files
    internal: true
    silent: true
    cmds:
      - echo "üîç Checking .local template files..."
      - |
        MISSING=0
        while IFS= read -r file; do
          if [[ ! -f "{{.PACKAGES_DIR}}/$file" ]]; then
            echo "  ‚úó Template missing: $file"
            MISSING=$((MISSING + 1))
          fi
        done < <(cd {{.PACKAGES_DIR}} && find . -type f -name "*.local" | sed 's|^\./||')

        if [[ $MISSING -eq 0 ]]; then
          echo "‚úì All template files found"
        else
          echo "‚ö†Ô∏è  $MISSING template(s) missing"
        fi
