# taskfiles/dotfiles.yml
version: 3

includes:
  backup:
    taskfile: ./backup.yml
    internal: true

vars:
  DOTFILES_DIR: '{{.ROOT_DIR}}'
  PACKAGES_DIR: '{{.DOTFILES_DIR}}/packages'
  STOW_FLAGS: '--restow --no-folding'
  # Dynamically get list of all package directories
  PACKAGES:
    sh: cd {{.PACKAGES_DIR}} && find . -maxdepth 1 -type d ! -name ".*" -exec basename {} \; | sort
  # Dynamically find all .local template files in packages
  LOCAL_FILES:
    sh: cd {{.PACKAGES_DIR}} && find . -type f -name "*.local" | sed 's|^\./||'

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  install:
    desc: Install all dotfiles using GNU Stow
    cmds:
      - task: ensure_dirs
      - task: stow:packages
      - task: copy_local_configs

  uninstall:
    desc: Remove dotfile symlinks
    cmds:
      - task: unstow:packages

  list:
    desc: List all available packages
    silent: true
    cmds:
      - echo "üì¶ Available packages:"
      - for:
          var: PACKAGES
          as: PACKAGE
        cmd: echo "  - {{.PACKAGE}}"

  restow:
    desc: Restow a specific package
    summary: |
      Restow a specific package by name
      Usage: task dot:restow PACKAGE=zsh
    vars:
      PACKAGE: '{{.PACKAGE | default ""}}'
    preconditions:
      - sh: test -n "{{.PACKAGE}}"
        msg: "PACKAGE variable is required. Usage: task dot:restow PACKAGE=zsh"
      - sh: test -d "{{.PACKAGES_DIR}}/{{.PACKAGE}}"
        msg: "Package '{{.PACKAGE}}' not found in {{.PACKAGES_DIR}}"
    cmds:
      - echo "üîÑ Restowing {{.PACKAGE}}..."
      - stow {{.STOW_FLAGS}} --dir={{.PACKAGES_DIR}} -t $HOME "{{.PACKAGE}}"
      - echo "‚úì {{.PACKAGE}} restowed successfully"

  # ============================================================================
  # Internal Tasks
  # ============================================================================

  ensure_dirs:
    internal: true
    cmds:
      - mkdir -p ~/.config
      - mkdir -p ~/.ssh
      - mkdir -p ~/.local/{bin,share}

  stow:packages:
    internal: true
    desc: Stow all packages
    cmds:
      - echo "üì¶ Stowing packages from {{.PACKAGES_DIR}}..."
      - for:
          var: PACKAGES
          as: PACKAGE
        task: stow:package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  stow:package:
    internal: true
    vars:
      PACKAGE: '{{.PACKAGE}}'
    cmds:
      - echo "  ‚Üí Stowing {{.PACKAGE}}..."
      - task: backup:backup_conflicts
        vars:
          PACKAGE: '{{.PACKAGE}}'
          PACKAGES_DIR: '{{.PACKAGES_DIR}}'
          STOW_FLAGS: '{{.STOW_FLAGS}}'
      - stow {{.STOW_FLAGS}} --dir={{.PACKAGES_DIR}} -t $HOME "{{.PACKAGE}}"

  unstow:packages:
    internal: true
    desc: Unstow all packages
    cmds:
      - echo "üì¶ Unstowing packages from {{.PACKAGES_DIR}}..."
      - for:
          var: PACKAGES
          as: PACKAGE
        task: unstow:package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  unstow:package:
    internal: true
    vars:
      PACKAGE: '{{.PACKAGE}}'
    cmds:
      - echo "  ‚Üí Unstowing {{.PACKAGE}}..."
      - stow --delete --dir={{.PACKAGES_DIR}} -t $HOME "{{.PACKAGE}}"
      - task: backup:restore_latest_package
        vars:
          PACKAGE: '{{.PACKAGE}}'

  copy_local_configs:
    internal: true
    desc: Copy .local template files from packages to $HOME if they don't exist
    cmds:
      - for:
          var: LOCAL_FILES
          as: LOCAL_FILE
        task: copy_local_file
        vars:
          LOCAL_FILE: '{{.LOCAL_FILE}}'

  copy_local_file:
    internal: true
    vars:
      LOCAL_FILE: '{{.LOCAL_FILE}}'
      # Extract just the filename (e.g., "zsh/.config/zsh/env.local" -> "env.local")
      FILENAME:
        sh: basename "{{.LOCAL_FILE}}"
      # Always copy to $HOME root with leading dot (e.g., "$HOME/.env.local")
      DEST_FILE: '$HOME/.{{.FILENAME}}'
    status:
      - test -f "{{.DEST_FILE}}"
    cmds:
      - echo "Copying {{.FILENAME}} to {{.DEST_FILE}}..."
      - cp "{{.PACKAGES_DIR}}/{{.LOCAL_FILE}}" "{{.DEST_FILE}}"
      - echo "‚úì Created {{.DEST_FILE}} - please customize it"

  # ============================================================================
  # Health Check / Doctor Tasks
  # ============================================================================

  doctor:
    desc: Check dotfiles health and integrity
    summary: |
      Runs comprehensive checks on dotfiles:
      - Verifies stowed symlinks point to correct locations
      - Finds broken symlinks in home directory
      - Checks for required directories
      - Validates .local template files exist

      Run this if something seems wrong with your dotfiles
    cmds:
      - task: doctor:symlinks
      - task: doctor:broken_links
      - task: doctor:directories
      - task: doctor:templates

  doctor:symlinks:
    desc: Check stowed symlinks integrity
    internal: true
    vars:
      STOWED_COUNT:
        sh: find ~ -maxdepth 3 -type l -lname "*/.dotfiles/*" 2>/dev/null | wc -l | tr -d ' '
    cmds:
      - echo "üîç Checking stowed symlinks..."
      - |
        if [[ "{{.STOWED_COUNT}}" -eq 0 ]]; then
          echo "‚ö†Ô∏è  No dotfiles symlinks found - run 'task dot:install' first"
        else
          echo "‚úì Found {{.STOWED_COUNT}} stowed symlink(s)"
        fi

  doctor:broken_links:
    desc: Check for broken symlinks
    internal: true
    cmds:
      - echo "üîç Checking for broken symlinks..."
      - |
        BROKEN=$(find ~ -maxdepth 3 -type l ! -exec test -e {} \; -print 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$BROKEN" -eq 0 ]]; then
          echo "‚úì No broken symlinks found"
        else
          echo "‚ö†Ô∏è  Found $BROKEN broken symlink(s) - run 'task clean:dead_symlinks' for details"
        fi

  doctor:directories:
    desc: Check required directories exist
    internal: true
    cmds:
      - echo "üîç Checking required directories..."
      - |
        MISSING=0
        for dir in ~/.config ~/.ssh ~/.local/bin ~/.local/share; do
          if [[ ! -d "$dir" ]]; then
            echo "  ‚úó Missing: $dir"
            MISSING=$((MISSING + 1))
          fi
        done
        if [[ $MISSING -eq 0 ]]; then
          echo "‚úì All required directories exist"
        else
          echo "‚ö†Ô∏è  $MISSING director(ies) missing - run 'task dot:install' to create them"
        fi

  doctor:templates:
    desc: Verify .local template files
    internal: true
    cmds:
      - echo "üîç Checking .local template files..."
      - |
        MISSING=0
        while IFS= read -r file; do
          if [[ ! -f "{{.PACKAGES_DIR}}/$file" ]]; then
            echo "  ‚úó Template missing: $file"
            MISSING=$((MISSING + 1))
          fi
        done < <(cd {{.PACKAGES_DIR}} && find . -type f -name "*.local" | sed 's|^\./||')

        if [[ $MISSING -eq 0 ]]; then
          echo "‚úì All template files found"
        else
          echo "‚ö†Ô∏è  $MISSING template(s) missing"
        fi
