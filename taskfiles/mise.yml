# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

silent: true

vars:
  # Determine Homebrew prefix based on architecture (for macOS)
  BREW_PREFIX:
    sh: |
      if [[ "$(uname)" == "Darwin" ]]; then
        if [[ $(uname -m) == "arm64" ]]; then
          echo "/opt/homebrew"
        else
          echo "/usr/local"
        fi
      else
        echo ""
      fi

tasks:
  # ============================================================================
  # Primary Tasks
  # ============================================================================

  setup:
    desc: Install mise tools and post-install dependencies (Playwright browsers)
    summary: |
      Full setup for mise-managed tools:
      1. Installs all tools from config
      2. Installs Playwright browsers for automation scripts
    cmds:
      - task: install
      - task: setup:playwright

  setup:playwright:
    desc: Install Playwright browsers (chromium)
    silent: true
    preconditions:
      - sh: command -v npx >/dev/null 2>&1
        msg: "npx not found. Run 'task mise:install' first"
    cmds:
      - echo "ðŸ“¦ Installing Playwright browsers..."
      - npx playwright install chromium
      - echo "âœ“ Playwright browsers installed"

  install:
    desc: Install all mise-managed tools from config
    summary: |
      Installs tools defined in .mise.toml or .tool-versions
      This will install all tools even if some are missing

      Note: GPG verification is disabled for easier setup on fresh systems
    preconditions:
      - sh: |
          {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
          command -v mise >/dev/null 2>&1
        msg: "mise is not installed. Run 'brew install mise' first"
      - sh: test -f ~/.config/mise/config.toml || test -f ~/.tool-versions || test -f ~/.config/mise/.mise.local.toml
        msg: "No mise config found. Expected ~/.config/mise/config.toml or ~/.tool-versions"
    cmds:
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        mise install

  update:
    aliases: [up, upgrade]
    desc: Update all mise-managed tools to latest versions
    preconditions:
      - sh: |
          {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
          command -v mise >/dev/null 2>&1
        msg: "mise is not installed"
    cmds:
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        mise up

  list:
    aliases: [ls]
    desc: List all installed tools and their versions
    cmds:
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        mise list

  outdated:
    desc: List all outdated tools
    cmds:
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        mise outdated -l

  # ============================================================================
  # Health Check
  # ============================================================================

  doctor:
    desc: Check mise installation and configuration
    summary: |
      Runs mise doctor to check for issues
      Note: Warnings about missing tools are expected during initial setup
    cmds:
      - |
        {{if ne .BREW_PREFIX ""}}export PATH="{{.BREW_PREFIX}}/bin:{{.BREW_PREFIX}}/sbin:$PATH"{{end}}
        mise doctor || true
